---
import { Image } from 'astro:assets';
import { getPostsPage, getPaginationRange } from '../../lib/wordpress';
import Layout from '../../layouts/Layout.astro';

const POSTS_PER_PAGE = 12;
const currentPage = 1;

const { posts, totalPosts } = await getPostsPage({
    limit: POSTS_PER_PAGE,
    offset: 0,
});

const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);

function formatPostDate(dateString) {
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year} - ${month} - ${day}`;
}


---

<Layout theme="light" isContact="yes">
    <div class="pg-wrap blog-gen">
        <section class="sc-grey sc-grey-C ps-rel">
            <div class="container">
                <div class="sc-headline">
                    <h1 class="txt-anim"><strong>Insights.</strong> <br/> Trusted by Industry Leaders.</h1>
                </div>
                <div class="posts-grid-wrap" id="masonry-grid">
                    {posts.map(post => {
                        const imageOld = post._embedded?.['wp:featuredmedia']?.[0]?.source_url;
                        const imageNew = post.acf_image_style?.source_url;
                        const imageToUse = imageNew || imageOld;
                        const shortTitle = post.acf.short_title;
                        return (
                            <div class="post-card">
                                <a href={`/blog/${post.slug}/`}>
                                    <div 
                                        class="post-image ps-rel"
                                        style={{
                                            backgroundImage: `url(${imageToUse})`,
                                            backgroundSize: 'cover',
                                            backgroundPosition: 'center',
                                            backgroundRepeat: 'no-repeat'
                                        }}
                                    >
                                        <div class="post-short-title fx fx-jc ps-rel">
                                            <h5>{shortTitle}</h5>
                                        </div>
                                    </div>
                                    <div class="post-info">
                                        <h6>{post.title.rendered}</h6>
                                        <p>{formatPostDate(post.date)}</p>
                                    </div>
                                </a>
                            </div>
                        );
                    })}
                </div>
                <div class="posts-navigation">
                    {totalPages > 1 && (
                        <nav class="pagination fx fx-jc fx-ac">
                            {getPaginationRange(currentPage, totalPages).map(item =>
                                item === '...' ? (
                                <span class="dots fx fx-ac fx-jc">...</span>
                                ) : (
                                <a
                                    href={item === 1 ? '/blog/' : `/blog/page/${item}/`}
                                    class={`fx fx-jc fx-ac${item === currentPage ? ' active' : ''}`}
                                >
                                    {item}
                                </a>
                                )
                            )}

                            {currentPage < totalPages && (
                                <a
                                    class="arrow arrow-next fx fx-ac fx-jc"
                                    href="/blog/page/2/"
                                    aria-label="Next page"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="8" height="12" viewBox="0 0 8 12" fill="none">
                                        <path d="M4.6 6L0 1.4L1.4 0L7.4 6L1.4 12L0 10.6L4.6 6Z" fill="#2C2C2C"/>
                                    </svg>
                                </a>
                            )}
                        </nav>
                    )}
                </div>
            </div>
        </section>
    </div>
</Layout>

<style>
    .sc-headline h1{
        color: var(--darkGrey);
    }
    .sc-headline h1 strong{
        color: #676B78;
        font-weight: 500;
    }
    .post-card{
        width: calc((100% - 2 * 24px) / 3);
    }
    .post-short-title{
        padding: 2rem 0 4rem 0;
        z-index: 1;
        min-height: 12rem;
    }
    .post-short-title h5{
        font-size: 3.25rem;
        line-height: 3.5rem;
        padding: 0 2rem;
        font-weight: 500;
        font-family: 'pp_neue_montrealmedium';
        color: var(--darkGrey);
    }
    .post-card .post-image:before{
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.4);
        z-index: 1;
    }
    .post-image{
        max-height: unset;
    }
    @media screen and (max-width: 700px) {
        .post-card {
            width: 100%;
        }
    }
    @media screen and (max-width: 479px) {
        .sc-headline {
            padding: 0 16px;
        }
    }
</style>

<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js" defer></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js" defer></script>
<script type="module" client:visible>
    import initMasonry from '/js/MasonryGridMain.js';
    initMasonry('#masonry-grid');
</script>